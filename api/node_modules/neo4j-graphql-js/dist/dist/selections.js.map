{"version":3,"sources":["../selections.js"],"names":["Object","defineProperty","exports","value","_extends2","require","_extends3","_interopRequireDefault","_toArray2","_toArray3","buildCypherSelection","_utils","obj","__esModule","default","_ref","initial","selections","variableName","schemaType","resolveInfo","length","_selections","headSelection","tailSelections","slice","tailParams","fieldName","name","commaIfTail","getFields","substring","lastIndexOf","fieldType","type","innerSchemaType","innerType","_cypherDirective","cypherDirective","customCypher","statement","isGraphqlScalarType","cypherDirectiveArgs","nestedVariable","skipLimit","computeSkipLimit","variableValues","nestedParams","selectionSet","fieldIsList","ofType","_relationDirective","relationDirective","relType","relDirection","direction","queryParams","innerFilterParams","isArrayType"],"mappings":"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","file":"selections.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _extends2 = require('babel-runtime/helpers/extends');\n\nvar _extends3 = _interopRequireDefault(_extends2);\n\nvar _toArray2 = require('babel-runtime/helpers/toArray');\n\nvar _toArray3 = _interopRequireDefault(_toArray2);\n\nexports.buildCypherSelection = buildCypherSelection;\n\nvar _utils = require('./utils');\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction buildCypherSelection(_ref) {\n  var initial = _ref.initial,\n      selections = _ref.selections,\n      variableName = _ref.variableName,\n      schemaType = _ref.schemaType,\n      resolveInfo = _ref.resolveInfo;\n\n  if (!selections.length) {\n    return initial;\n  }\n\n  var _selections = (0, _toArray3.default)(selections),\n      headSelection = _selections[0],\n      tailSelections = _selections.slice(1);\n\n  var tailParams = {\n    selections: tailSelections,\n    variableName: variableName,\n    schemaType: schemaType,\n    resolveInfo: resolveInfo\n  };\n\n  var fieldName = headSelection.name.value;\n  var commaIfTail = tailSelections.length > 0 ? ',' : '';\n\n  // Schema meta fields(__schema, __typename, etc)\n  if (!schemaType.getFields()[fieldName]) {\n    return buildCypherSelection((0, _extends3.default)({\n      initial: tailSelections.length ? initial : initial.substring(0, initial.lastIndexOf(','))\n    }, tailParams));\n  }\n\n  var fieldType = schemaType.getFields()[fieldName].type;\n  var innerSchemaType = (0, _utils.innerType)(fieldType); // for target \"type\" aka label\n\n  var _cypherDirective = (0, _utils.cypherDirective)(schemaType, fieldName),\n      customCypher = _cypherDirective.statement;\n\n  // Database meta fields(_id)\n\n\n  if (fieldName === '_id') {\n    return buildCypherSelection((0, _extends3.default)({\n      initial: '' + initial + fieldName + ': ID(' + variableName + ')' + commaIfTail\n    }, tailParams));\n  }\n\n  // Main control flow\n  if ((0, _utils.isGraphqlScalarType)(innerSchemaType)) {\n    if (customCypher) {\n      return buildCypherSelection((0, _extends3.default)({\n        initial: '' + initial + fieldName + ': apoc.cypher.runFirstColumn(\"' + customCypher + '\", ' + (0, _utils.cypherDirectiveArgs)(variableName, headSelection, schemaType, resolveInfo) + ', false)' + commaIfTail\n      }, tailParams));\n    }\n\n    // graphql scalar type, no custom cypher statement\n    return buildCypherSelection((0, _extends3.default)({\n      initial: initial + ' .' + fieldName + ' ' + commaIfTail\n    }, tailParams));\n  }\n\n  // We have a graphql object type\n\n  var nestedVariable = variableName + '_' + fieldName;\n  var skipLimit = (0, _utils.computeSkipLimit)(headSelection, resolveInfo.variableValues);\n\n  var nestedParams = {\n    initial: '',\n    selections: headSelection.selectionSet.selections,\n    variableName: nestedVariable,\n    schemaType: innerSchemaType,\n    resolveInfo: resolveInfo\n  };\n\n  if (customCypher) {\n    // similar: [ x IN apoc.cypher.runFirstColumn(\"WITH {this} AS this MATCH (this)--(:Genre)--(o:Movie) RETURN o\", {this: movie}, true) |x {.title}][1..2])\n    var fieldIsList = !!fieldType.ofType;\n\n    return buildCypherSelection((0, _extends3.default)({\n      initial: '' + initial + fieldName + ': ' + (fieldIsList ? '' : 'head(') + '[ ' + nestedVariable + ' IN apoc.cypher.runFirstColumn(\"' + customCypher + '\", ' + (0, _utils.cypherDirectiveArgs)(variableName, headSelection, schemaType, resolveInfo) + ', true) | ' + nestedVariable + ' {' + buildCypherSelection((0, _extends3.default)({}, nestedParams)) + '}]' + (fieldIsList ? '' : ')') + skipLimit + ' ' + commaIfTail\n    }, tailParams));\n  }\n\n  // graphql object type, no custom cypher\n\n  var _relationDirective = (0, _utils.relationDirective)(schemaType, fieldName),\n      relType = _relationDirective.name,\n      relDirection = _relationDirective.direction;\n\n  var queryParams = (0, _utils.innerFilterParams)(selections);\n\n  return buildCypherSelection((0, _extends3.default)({\n    initial: '' + initial + fieldName + ': ' + (!(0, _utils.isArrayType)(fieldType) ? 'head(' : '') + '[(' + variableName + ')' + (relDirection === 'in' || relDirection === 'IN' ? '<' : '') + '-[:' + relType + ']-' + (relDirection === 'out' || relDirection === 'OUT' ? '>' : '') + '(' + nestedVariable + ':' + innerSchemaType.name + queryParams + ') | ' + nestedVariable + ' {' + buildCypherSelection((0, _extends3.default)({}, nestedParams)) + '}]' + (!(0, _utils.isArrayType)(fieldType) ? ')' : '') + skipLimit + ' ' + commaIfTail\n  }, tailParams));\n}"]}